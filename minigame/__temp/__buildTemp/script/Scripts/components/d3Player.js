"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var engine_1 = require("engine");
var collider_1 = require("../commons/collider");
var dataCenter_1 = require("../commons/dataCenter");
var eventCenter_1 = require("../commons/eventCenter");
var d3Bullet_1 = require("./d3Bullet");
var POS_LIMIT = {
    x: [-30, 30],
    z: [-54, 14.3],
};
var D3Player = (function (_super) {
    tslib_1.__extends(D3Player, _super);
    function D3Player() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.bulletPrefab = null;
        _this.bulletInterval = 0.3;
        _this.bulletTime = 0;
        _this.player = null;
        _this.hurtParticle = null;
        _this.speed = 10;
        _this.direction = engine_1.default.Vector3.ZERO.clone();
        _this.rotation = engine_1.default.Vector3.ZERO.clone();
        _this.bound = engine_1.default.Vector3.createFromNumber(2.75 / 2, 0.46 / 2, 0.5 / 2);
        return _this;
    }
    D3Player.prototype.onAwake = function () {
        console.log("onAwake D3Player");
        this.player = this.entity;
        dataCenter_1.default.playerEntity = this.player;
        dataCenter_1.default.playerComp = this;
        this.hurtParticle = this.player.transform._children[0].findChildByName("Hurt").entity.getComponent(engine_1.default.Particle);
        this.initEvent();
        this.initPrefab();
        collider_1.default.watch(this, ["player"]);
        eventCenter_1.default.emit(eventCenter_1.default.ADD_PLAYER);
    };
    D3Player.prototype.onUpdate = function (dt) {
        if (this.player) {
            this.updateMove(dt);
            this.updateBullet(dt);
        }
    };
    D3Player.prototype.initPrefab = function () {
        var _this = this;
        engine_1.default.loader.load("resource/Bullet.prefab").promise.then(function (prefab) {
            _this.bulletPrefab = prefab;
        });
    };
    D3Player.prototype.initEvent = function () {
        var _this = this;
        eventCenter_1.default.on(eventCenter_1.default.TOUCH_MOVE, function (direction) {
            _this.direction.x = direction.x;
            _this.direction.y = direction.y;
            _this.direction.z = direction.z;
            if (direction.x === 0) {
                _this.rotation.x = 0;
                _this.rotation.z = 0;
            }
            else {
                _this.rotation.x = 0.01;
                _this.rotation.z = direction.x < 0 ? 0.01 : -0.01;
            }
        });
        eventCenter_1.default.on(eventCenter_1.default.HURT_PLAYER, function () {
            _this.hurtParticle.emitter.start = true;
        });
        eventCenter_1.default.on(eventCenter_1.default.START_SHOOT, function () {
            _this.bulletInterval = 0.1;
        });
        eventCenter_1.default.on(eventCenter_1.default.END_SHOOT, function () {
            _this.bulletInterval = 0.3;
        });
    };
    D3Player.prototype.updateMove = function (dt) {
        for (var k in POS_LIMIT) {
            if (this.rotation[k] === 0) {
                this.player.transform.euler[k] = 0;
            }
            else {
                this.player.transform.euler[k] += this.rotation[k];
                if (this.player.transform.euler[k] > 0.2) {
                    this.player.transform.euler[k] = 0.2;
                }
                else if (this.player.transform.euler[k] < -0.2) {
                    this.player.transform.euler[k] = -0.2;
                }
            }
        }
        var move = {
            x: this.speed * this.direction.x * dt,
            y: this.speed * this.direction.y * dt,
            z: this.speed * this.direction.z * dt,
        };
        var pos = this.player.transform.position;
        for (var k in POS_LIMIT) {
            if (pos[k] + move[k] < POS_LIMIT[k][0]
                ||
                    pos[k] + move[k] > POS_LIMIT[k][1]) {
                move[k] = 0;
            }
            this.player.transform.position[k] += move[k];
        }
        if (move.x !== 0 || move.y !== 0 || move.z !== 0) {
            eventCenter_1.default.emit(eventCenter_1.default.MOVE_PLAYER, move);
        }
    };
    D3Player.prototype.updateBullet = function (dt) {
        if (!this.bulletPrefab) {
            return;
        }
        this.bulletTime += dt;
        if (this.bulletTime >= this.bulletInterval) {
            var entity = this.bulletPrefab.instantiate();
            var script = entity.addComponent(d3Bullet_1.default);
            entity.transform.position = this.player.transform.position.clone();
            script.direction.z = -1;
            dataCenter_1.default.worldEntity.transform.addChild(entity.transform);
            this.bulletTime -= this.bulletInterval;
        }
    };
    D3Player = tslib_1.__decorate([
        engine_1.default.decorators.serialize("D3Player")
    ], D3Player);
    return D3Player;
}(engine_1.default.Script));
exports.default = D3Player;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNjcmlwdHMvY29tcG9uZW50cy9kM1BsYXllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBNEI7QUFDNUIsZ0RBQTJDO0FBQzNDLG9EQUErQztBQUMvQyxzREFBaUQ7QUFDakQsdUNBQWtDO0FBRWxDLElBQU0sU0FBUyxHQUFHO0lBQ2hCLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQztJQUVaLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQztDQUNmLENBQUM7QUFHRjtJQUFzQyxvQ0FBYTtJQUFuRDtRQUFBLHFFQStIQztRQTlIUSxrQkFBWSxHQUFHLElBQUksQ0FBQztRQUNwQixvQkFBYyxHQUFHLEdBQUcsQ0FBQztRQUNyQixnQkFBVSxHQUFHLENBQUMsQ0FBQztRQUNmLFlBQU0sR0FBRyxJQUFJLENBQUM7UUFDZCxrQkFBWSxHQUFHLElBQUksQ0FBQztRQUNwQixXQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsZUFBUyxHQUFHLGdCQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN4QyxjQUFRLEdBQUcsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3ZDLFdBQUssR0FBRyxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLElBQUksR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDOztJQXNIOUUsQ0FBQztJQXBIUSwwQkFBTyxHQUFkO1FBQ0UsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBR2hDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUMxQixvQkFBVSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3RDLG9CQUFVLENBQUMsVUFBVSxHQUFHLElBQUksQ0FB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QUksSUFBSSxDQUFDLGNBQWMsQ0FBQztTQUN4QztJQUNILENBQUM7SUE5SGtCLFFBQVE7UUFENUIsZ0JBQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQztPQUNuQixRQUFRLENBK0g1QjtJQUFELGVBQUM7Q0EvSEQsQUErSEMsQ0EvSHFDLGdCQUFNLENBQUMsTUFBTSxHQStIbEQ7a0JBL0hvQixRQUFRIiwiZmlsZSI6IlNjcmlwdHMvY29tcG9uZW50cy9kM1BsYXllci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBlbmdpbmUgZnJvbSAnZW5naW5lJztcbmltcG9ydCBDb2xsaWRlciBmcm9tICcuLi9jb21tb25zL2NvbGxpZGVyJztcbmltcG9ydCBEYXRhQ2VudGVyIGZyb20gJy4uL2NvbW1vbnMvZGF0YUNlbnRlcic7XG5pbXBvcnQgRXZlbnRDZW50ZXIgZnJvbSAnLi4vY29tbW9ucy9ldmVudENlbnRlcic7XG5pbXBvcnQgRDNCdWxsZXQgZnJvbSAnLi9kM0J1bGxldCc7XG5cbmNvbnN0IFBPU19MSU1JVCA9IHtcbiAgeDogWy0zMCwgMzBdLFxuICAvLyB5OiBbLTEwMCwgMTAwXSxcbiAgejogWy01NCwgMTQuM10sXG59O1xuXG5AZW5naW5lLmRlY29yYXRvcnMuc2VyaWFsaXplKFwiRDNQbGF5ZXJcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEQzUGxheWVyIGV4dGVuZHMgZW5naW5lLlNjcmlwdCB7XG4gIHB1YmxpYyBidWxsZXRQcmVmYWIgPSBudWxsO1xuICBwdWJsaWMgYnVsbGV0SW50ZXJ2YWwgPSAwLjM7XG4gIHB1YmxpYyBidWxsZXRUaW1lID0gMDtcbiAgcHVibGljIHBsYXllciA9IG51bGw7XG4gIHB1YmxpYyBodXJ0UGFydGljbGUgPSBudWxsO1xuICBwdWJsaWMgc3BlZWQgPSAxMDtcbiAgcHVibGljIGRpcmVjdGlvbiA9IGVuZ2luZS5WZWN0b3IzLlpFUk8uY2xvbmUoKTtcbiAgcHVibGljIHJvdGF0aW9uID0gZW5naW5lLlZlY3RvcjMuWkVSTy5jbG9uZSgpO1xuICBwdWJsaWMgYm91bmQgPSBlbmdpbmUuVmVjdG9yMy5jcmVhdGVGcm9tTnVtYmVyKDIuNzUgLyAyLCAwLjQ2IC8gMiwgMC41IC8gMik7XG5cbiAgcHVibGljIG9uQXdha2UoKSB7XG4gICAgY29uc29sZS5sb2coXCJvbkF3YWtlIEQzUGxheWVyXCIpO1xuICAgIC8vIHRoaXMuaW5pdEVudGl0eSgpO1xuXG4gICAgdGhpcy5wbGF5ZXIgPSB0aGlzLmVudGl0eTtcbiAgICBEYXRhQ2VudGVyLnBsYXllckVudGl0eSA9IHRoaXMucGxheWVyO1xuICAgIERhdGFDZW50ZXIucGxheWVyQ29tcCA9IHRoaXM7XG5cbiAgICB0aGlzLmh1cnRQYXJ0aWNsZSA9IHRoaXMucGxheWVyLnRyYW5zZm9ybS5fY2hpbGRyZW5bMF0uZmluZENoaWxkQnlOYW1lKFwiSHVydFwiKS5lbnRpdHkuZ2V0Q29tcG9uZW50KGVuZ2luZS5QYXJ0aWNsZSk7XG4gICAgLy8gdGhpcy5odXJ0UGFydGljbGUuZW1pdHRlci5zdGFydCA9IHRydWU7XG5cbiAgICB0aGlzLmluaXRFdmVudCgpO1xuICAgIHRoaXMuaW5pdFByZWZhYigpO1xuICAgIENvbGxpZGVyLndhdGNoKHRoaXMsIFtcInBsYXllclwiXSk7XG5cbiAgICBFdmVudENlbnRlci5lbWl0KEV2ZW50Q2VudGVyLkFERF9QTEFZRVIpO1xuICB9XG5cbiAgcHVibGljIG9uVXBkYXRlKGR0KSB7XG4gICAgaWYgKHRoaXMucGxheWVyKSB7XG4gICAgICB0aGlzLnVwZGF0ZU1vdmUoZHQpO1xuICAgICAgdGhpcy51cGRhdGVCdWxsZXQoZHQpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpbml0UHJlZmFiKCkge1xuICAgIGVuZ2luZS5sb2FkZXIubG9hZChcInJlc291cmNlL0J1bGxldC5wcmVmYWJcIikucHJvbWlzZS50aGVuKChwcmVmYWIpID0+IHtcbiAgICAgIHRoaXMuYnVsbGV0UHJlZmFiID0gcHJlZmFiO1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGluaXRFdmVudCgpIHtcbiAgICBFdmVudENlbnRlci5vbihFdmVudENlbnRlci5UT1VDSF9NT1ZFLCAoZGlyZWN0aW9uKSA9PiB7XG4gICAgICAvLyBjb25zb2xlLmxvZygnZ2V0IDJkIE9OX1RPVUNIX01PVkUnLCBkaXJlY3Rpb24ueCwgZGlyZWN0aW9uLnksIGRpcmVjdGlvbi56KTtcbiAgICAgIHRoaXMuZGlyZWN0aW9uLnggPSBkaXJlY3Rpb24ueDtcbiAgICAgIHRoaXMuZGlyZWN0aW9uLnkgPSBkaXJlY3Rpb24ueTtcbiAgICAgIHRoaXMuZGlyZWN0aW9uLnogPSBkaXJlY3Rpb24uejtcblxuICAgICAgaWYgKGRpcmVjdGlvbi54ID09PSAwKSB7XG4gICAgICAgIHRoaXMucm90YXRpb24ueCA9IDA7XG4gICAgICAgIHRoaXMucm90YXRpb24ueiA9IDA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnJvdGF0aW9uLnggPSAwLjAxO1xuICAgICAgICB0aGlzLnJvdGF0aW9uLnogPSBkaXJlY3Rpb24ueCA8IDAgPyAwLjAxIDogLTAuMDE7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBFdmVudENlbnRlci5vbihFdmVudENlbnRlci5IVVJUX1BMQVlFUiwgKCkgPT4ge1xuICAgICAgdGhpcy5odXJ0UGFydGljbGUuZW1pdHRlci5zdGFydCA9IHRydWU7XG4gICAgfSk7XG5cbiAgICBFdmVudENlbnRlci5vbihFdmVudENlbnRlci5TVEFSVF9TSE9PVCwgKCkgPT4ge1xuICAgICAgdGhpcy5idWxsZXRJbnRlcnZhbCA9IDAuMTtcbiAgICB9KTtcbiAgICBFdmVudENlbnRlci5vbihFdmVudENlbnRlci5FTkRfU0hPT1QsICgpID0+IHtcbiAgICAgIHRoaXMuYnVsbGV0SW50ZXJ2YWwgPSAwLjM7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlTW92ZShkdCkge1xuICAgIGZvciAoY29uc3QgayBpbiBQT1NfTElNSVQpIHtcbiAgICAgIGlmICh0aGlzLnJvdGF0aW9uW2tdID09PSAwKSB7XG4gICAgICAgIHRoaXMucGxheWVyLnRyYW5zZm9ybS5ldWxlcltrXSA9IDA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnBsYXllci50cmFuc2Zvcm0uZXVsZXJba10gKz0gdGhpcy5yb3RhdGlvbltrXTtcbiAgICAgICAgaWYgKHRoaXMucGxheWVyLnRyYW5zZm9ybS5ldWxlcltrXSA+IDAuMikge1xuICAgICAgICAgIHRoaXMucGxheWVyLnRyYW5zZm9ybS5ldWxlcltrXSA9IDAuMjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnBsYXllci50cmFuc2Zvcm0uZXVsZXJba10gPCAtMC4yKSB7XG4gICAgICAgICAgdGhpcy5wbGF5ZXIudHJhbnNmb3JtLmV1bGVyW2tdID0gLTAuMjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICAvLyB0aGlzLmVudGl0eS50cmFuc2Zvcm0uZXVsZXIueSArPSAwLjAzO1xuXG5cbiAgICBjb25zdCBtb3ZlID0ge1xuICAgICAgeDogdGhpcy5zcGVlZCAqIHRoaXMuZGlyZWN0aW9uLnggKiBkdCxcbiAgICAgIHk6IHRoaXMuc3BlZWQgKiB0aGlzLmRpcmVjdGlvbi55ICogZHQsXG4gICAgICB6OiB0aGlzLnNwZWVkICogdGhpcy5kaXJlY3Rpb24ueiAqIGR0LFxuICAgIH07XG4gICAgY29uc3QgcG9zID0gdGhpcy5wbGF5ZXIudHJhbnNmb3JtLnBvc2l0aW9uO1xuICAgIGZvciAoY29uc3QgayBpbiBQT1NfTElNSVQpIHtcbiAgICAgIGlmIChcbiAgICAgICAgcG9zW2tdICsgbW92ZVtrXSA8IFBPU19MSU1JVFtrXVswXVxuICAgICAgICB8fFxuICAgICAgICBwb3Nba10gKyBtb3ZlW2tdID4gUE9TX0xJTUlUW2tdWzFdXG4gICAgICApIHtcbiAgICAgICAgbW92ZVtrXSA9IDA7XG4gICAgICB9XG4gICAgICB0aGlzLnBsYXllci50cmFuc2Zvcm0ucG9zaXRpb25ba10gKz0gbW92ZVtrXTtcbiAgICB9XG4gICAgaWYgKG1vdmUueCAhPT0gMCB8fCBtb3ZlLnkgIT09IDAgfHwgbW92ZS56ICE9PSAwKSB7XG4gICAgICBFdmVudENlbnRlci5lbWl0KEV2ZW50Q2VudGVyLk1PVkVfUExBWUVSLCBtb3ZlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlQnVsbGV0KGR0KSB7XG4gICAgaWYgKCF0aGlzLmJ1bGxldFByZWZhYikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmJ1bGxldFRpbWUgKz0gZHQ7XG4gICAgaWYgKHRoaXMuYnVsbGV0VGltZSA+PSB0aGlzLmJ1bGxldEludGVydmFsKSB7XG4gICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmJ1bGxldFByZWZhYi5pbnN0YW50aWF0ZSgpO1xuICAgICAgY29uc3Qgc2NyaXB0ID0gZW50aXR5LmFkZENvbXBvbmVudChEM0J1bGxldCk7XG4gICAgICBlbnRpdHkudHJhbnNmb3JtLnBvc2l0aW9uID0gdGhpcy5wbGF5ZXIudHJhbnNmb3JtLnBvc2l0aW9uLmNsb25lKCk7XG4gICAgICAvLyBzY3JpcHQuZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb24uY2xvbmUoKTtcbiAgICAgIC8vIGlmICh0aGlzLmRpcmVjdGlvbi5pc1plcm8oKSkge1xuICAgICAgLy8gICBzY3JpcHQuZGlyZWN0aW9uLnogPSAtMTtcbiAgICAgIC8vIH1cbiAgICAgIHNjcmlwdC5kaXJlY3Rpb24ueiA9IC0xO1xuXG4gICAgICBEYXRhQ2VudGVyLndvcmxkRW50aXR5LnRyYW5zZm9ybS5hZGRDaGlsZChlbnRpdHkudHJhbnNmb3JtKTtcblxuICAgICAgdGhpcy5idWxsZXRUaW1lIC09IHRoaXMuYnVsbGV0SW50ZXJ2YWw7XG4gICAgfVxuICB9XG59XG4iXX0=
